<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="/stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/stylesheets/print.css" media="print">
	<link rel="icon" href="/images/page.ico">
    <title>Xd216 Lab Blog</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Xd216的博客</h1>
        
        <a href="https://github.com/xd216" class="button"><small>Follow me on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">        
        <h1>
<a name="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages"><span class="octicon octicon-link"></span></a> 
Grails-GORM-CRUD 
        </h1>
<h2>save|update</h2>

<p>默认的每次save操作并不会立即被推到数据库,而是在下次<code>session.flush()</code>发生时被推到数据库.</p>

<p><code>session.flush()</code>执行时,清除HibernateSession缓存,使数据库与hibernate缓存同步,保证数据一致性.并向DB发送sql语句.</p>
<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="kt">def</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="n">p</span><span class="o">.</span><span class="na">save</span><span class="o">()</span>
</code></pre></div>
<p>每次save一个对象时,grails自动验证domain中的规则,如果验证失败,save操作失败,不会将对象持久化到数据库.默认返回<code>null</code>,可以进行异常控制如下:</p>
<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="kt">def</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">p</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="nl">failOnError:</span> <span class="kc">true</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="n">ValidationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// deal with exception</span>
<span class="o">}</span>
</code></pre></div>
<h2>delete</h2>
<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="kt">def</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="n">p</span><span class="o">.</span><span class="na">delete</span><span class="o">()</span>
</code></pre></div>
<p>同save操作一样,delete操作也是使用<code>write-behind</code>事务策略,如果想每次执行delete/save操作时,立即刷新缓存,应该采取:<code>p.delete(flush:true)</code>.</p>

<p>使用<code>flush:true</code>的好处是,当此次删除操作发生异常时,可以控制此异常.</p>

<p>常见的情况是:违反数据库的约束进行删除操作</p>
<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="k">try</span> <span class="o">{</span>
    <span class="n">p</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="nl">flush:</span> <span class="kc">true</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">dao</span><span class="o">.</span><span class="na">DataIntegrityViolationException</span> <span class="n">e</span><span class="o">)</span> 
<span class="o">{</span>
    <span class="n">flash</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="s2">&quot;Could not delete person&quot;</span>
     <span class="n">redirect</span><span class="o">(</span><span class="nl">action:</span> <span class="s2">&quot;show&quot;</span><span class="o">,</span> <span class="nl">id:</span> <span class="n">p</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div>
<p>批量删除:</p>
<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="n">Customer</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="s2">&quot;delete Customer c where c.name = :oldName&quot;</span><span class="o">,</span>
                       <span class="o">[</span><span class="nl">oldName:</span> <span class="s2">&quot;Fred&quot;</span><span class="o">])</span>
</code></pre></div>
<h2>级联更新和删除</h2>

<h4>不论一对一,一对多,多对多,定义<code>belongsTo</code>就会使更新操作从拥有者级联到从属者.删除操作:多/一对一,一对多是级联的.</h4>

<p>不定义<code>belongsTo</code>的话,不会自动级联,需要手动操作</p>

<p>示例:一个</p>

        </section>

        <aside id="sidebar">


          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>
